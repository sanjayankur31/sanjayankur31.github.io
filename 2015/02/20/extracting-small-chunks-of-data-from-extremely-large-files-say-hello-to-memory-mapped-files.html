<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="Ankur Sinha" />
    <meta name="generator" content="Pelican (VoidyBootstrap theme)" />
    <meta name="twitter:card" content="summary"> 
    <meta name="twitter:title" content="Extracting small chunks of data from EXTREMELY LARGE files - say hello to memory mapped files">
    <meta name="twitter:description" content="">
    <meta name="twitter:site" content="@sanjay_ankur">
    <meta name="twitter:creator" content="@sanjay_ankur">
    <meta name="twitter:domain" content="http://ankursinha.in">

    <title>Extracting small chunks of data from EXTREMELY LARGE files - say hello to memory mapped files - ankursinha.in/blog</title>

   
        <link rel="stylesheet"
              href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
              integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
              crossorigin="anonymous" />
      <link rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.0.12/css/all.css"
      integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9"
      crossorigin="anonymous">


      <link rel="stylesheet" href="http://ankursinha.in/theme/css/use-opensans.css" />
      <link rel="stylesheet" href="http://ankursinha.in/theme/css/voidybootstrap.css" />
      <link rel="stylesheet" href="http://ankursinha.in/theme/css/pygment.css" />

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js" integrity="sha384-FFgGfda92tXC8nCNOxrCQ3R8x1TNkMFqDZVQdDaaJiiVbjkPBXIJBx0o7ETjy8Bh" crossorigin="anonymous"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js" integrity="sha384-ZoaMbDF+4LeFxg6WdScQ9nnR1QC2MIRxA1O9KWEXQwns1G8UNyIEZIQidzb0T1fo" crossorigin="anonymous"></script>
    <![endif]-->

    <link rel="shortcut icon" href="http://ankursinha.in/favicon.ico" />
        <link href="http://ankursinha.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ankursinha.in/blog Atom Feed" />
        <link href="http://ankursinha.in/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="ankursinha.in/blog RSS Feed" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60261100-1', '');
  ga('send', 'pageview');

</script>
  </head>

  <body>
   
    <nav class="navbar navbar-default">
      <div class="container">
	   <div class="navbar-header">
		<button type="button" class="navbar-toggle" 
				data-toggle="collapse" data-target="#main-navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="http://ankursinha.in/" rel="home">
          <i class="fas fa-home fa-fw fa-lg"> </i> </a>
       </div>

      <div class="collapse navbar-collapse" id="main-navbar-collapse">
        <ul class="nav navbar-nav">
              <li>
                <a href="http://ankursinha.in/pages/01-about.html">About Me</a>
              </li>
              <li>
                <a href="http://ankursinha.in/pages/02-research-profile.html">Research Profile</a>
              </li>
              <li>
                <a href="http://ankursinha.in/pages/04-current-work.html">Current work</a>
              </li>
            <li class="divider"></li>
            <li class="">
              <a href="http://ankursinha.in/pages/03-publications.html">Publications</a>
            </li>
            <li class="">
              <a href="http://ankursinha.in/pages/archives.html">Archives</a>
            </li>
          <li class="divider"></li>
            <li><a href="http://ankursinha.in/feeds/all.atom.xml" 
                   type="application/atom+xml" rel="alternate">
                <i class="fas fa-rss fa-fw fa-lg"></i> </a></li>
        </ul> <!-- /nav -->
      </div> <!-- /navbar-collapse -->
	  </div> <!-- /container -->
    </nav> <!-- /navbar -->

	<div class="jumbotron" id="overview">
	  <div class="container">
		<h1><a href="http://ankursinha.in/">ankursinha.in/blog</a></h1>
		<p class="lead">neuroscience/fedora/musings</p>
	  </div>
	</div>

    <div class="container" id="main-container">
      <div class="row">
        <div class="col-md-9" id="content">
<article itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
  <header class="article-header">
<abbr class="article-header-date">
  Fri 20 February 2015
</abbr> <h1>
  <a href="http://ankursinha.in/2015/02/20/extracting-small-chunks-of-data-from-extremely-large-files-say-hello-to-memory-mapped-files.html" rel="bookmark"
     title="Permalink to Extracting small chunks of data from EXTREMELY LARGE files - say hello to memory mapped files">
    Extracting small chunks of data from EXTREMELY LARGE files - say hello to memory mapped files
  </a>
</h1><div class="article-header-info">
  <p>
      Posted by <a href="http://ankursinha.in/author/ankur.html">ankur</a>
    in 
    <a href="http://ankursinha.in/category/research/">
      Research</a>
(2138 words, approximately a 9 minute read)
  </p>
</div> <!-- /.article-header-info -->  </header>
  <div class="content-body" itemprop="text articleBody">
	<div class="section" id="the-story-so-far">
<h2>The story so far ...</h2>
<p><em>Beware - lots of PhDcomics links in the text!</em></p>
<p>The first post on my research blog, finally - wait! I mean &quot;Hello
World&quot;!</p>
<p>Research is going really well - <a class="reference external" href="http://phdcomics.com/comics.php">the supervisors seem happy</a> and I
haven't considered <a class="reference external" href="http://www.phdcomics.com/comics/archive.php?comicid=1495">killing myself out of frustration yet</a> or even
worse - <a class="reference external" href="http://www.phdcomics.com/comics/archive.php?comicid=1490">I haven't once wondered if a research career was a mistake to
take up</a>. I've now been signed up as a visiting lecturer and after my
first stint with <a class="reference external" href="http://www.phdcomics.com/comics/archive.php?comicid=974">marking undergraduate examination papers</a>, I'm a lot
happier supervising BSc final year projects. (The marking didn't
actually go that bad - most of them scored more than 75%, and no, I'm
not a lenient marker!). I am looking forward to teaching, though - I
expect to thoroughly enjoy putting an entire class to sleep!</p>
<p>Anyway, on to the sciency stuff!</p>
</div>
<div class="section" id="memory-mapped-files">
<h2>Memory mapped files?</h2>
<p>Some background on how I came across <a class="reference external" href="https://en.wikipedia.org/wiki/Memory-mapped_file">memory mapped files</a> before we
begin. On a typical day, I run multiple iterations of simulations. Each
of these simulations deals with about <strong>10,000 neurons and runs for a
total simulation time of about 8 hours</strong>. I specify simulation time
because the library I use, <a class="reference external" href="http://www.fzenke.net/auryn/doku.php">Auryn</a>, is written in C++ and uses <a class="reference external" href="https://en.wikipedia.org/wiki/Message_Passing_Interface">MPI</a>
to speed this up and reduces the actual running time to about an hour
and a half. Anyway, to cut the long story short, my simulation produces
a lot of data - generally in the order of 30Gbs - one simulation had
produced more than 200Gbs, even. This is only spike data, as explained
<a class="reference external" href="http://www.fzenke.net/auryn/doku.php?id=manual:ras">here</a>. I've only begun my PhD and I expect my simulations to get
longer and more complicated, which logically implies that the amount of
data that I'll have to post process will also increase accordingly.</p>
<p>The information I usually need from my simulation data is the spike
information of individual neurons (number of spikes in a time period -
the firing rate) in between certain times - simulation snapshots, we
call them. <strong>So, from 30Gigs of data, I need to search, process and
actually only plot a couple of hundred MBs at the most, generally tens
of MBs or less</strong>. The simplest way of doing this is - read all your data
in, find the required snapshots, extract them and move on with the post
processing. With 30Gigs of data, I could probably do this - my server
has more RAM than that, but, it'll still take the system time to read
all this data into memory. This is what I was doing a month back, though
- before I started looking for more efficient techniques. An <strong>R
script</strong> (the supposed standard language for big data) was used for a
while - still read all the data into memory. <strong>Databases</strong> were
considered and duly dismissed - I'm not going to save 30Gigs of data for
each simulation when I only need a few MBs. The database will anyway run
indexing operations on the data which will still make it take a while to
load the data and the data loading part was what I was really looking to
quicken.</p>
<p>After looking around for quick disc access, I found <strong>memory mapped
files</strong>. As the wikipedia article says, &quot;<strong>A memory-mapped file is a
segment of virtual memory which has been assigned a direct byte-for-byte
correlation with some portion of a file or file-like resource.</strong>&quot; The
useful bit is where it says, &quot;<strong>Once present, this correlation between
the file and the memory space permits applications to treat the mapped
portion as if it were primary memory.</strong>&quot;. So, basically, you have a
large file, but you don't need to read it into memory - you simply
<strong>map</strong> it into memory. Once you've done that, you use <strong>pointer
arithmetic</strong> to calculate and <strong>extract only the required chunks</strong>.
Simple? Yes! Well, almost. Since you're going to be using pointer
arithmetic to calculate your data locations, data where each entry is of
a <strong>uniform size</strong> is quite important. You can still do it without
uniform data, but that'll require you to use a sentinel like a &quot;n&quot; to
find each line and you'll have to go through the entire file anyway -
it'll just be more complicated. To use my memory mapped file method, I
first got the simulator to output data in binary format - where I could
ensure that the size of each record was the same. This is really simple
to do with a <strong>struct</strong>, like this:</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="p">{</span>  <span class="n">AurynTime</span> <span class="n">time</span><span class="p">;</span>  <span class="n">NeuronID</span> <span class="n">neuronID</span><span class="p">;</span> <span class="p">};</span>
</pre></div>
<p>As long as you're running both the read and write operations on the same
machine, with the same compiler, you can be quite certain that the size
of the struct will not change between the time you write the data and
then read it from your post-processing script. Memory mapped files can
be used for a lot more, of course, but we only require multi-threaded
reads which means we don't need to use locks or mutexes or the sort to
prevent race conditions at all.</p>
</div>
<div class="section" id="the-code">
<h2>The code</h2>
<p>If you've made it this far, here's your reward - the code (snippets)!</p>
<p>I use <a class="reference external" href="http://www.boost.org/doc/libs/1_50_0/libs/iostreams/doc/classes/mapped_file.html">boost's implementation of memory mapped files</a>. I couldn't find
any tutorials, but a post or two gave me the idea on how to use the API.
So, you need this inclusion:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;boost/iostreams/device/mapped_file.hpp&gt;</span><span class="cp"></span>
</pre></div>
<p>Each MPI rank produces a separate file, so I have 16 files here, since
I use 16 ranks. Instead of sorting and merging them, I simply map them
all. A vector, therefore appears, and holds my memory mapped file
objects:</p>
<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">iostreams</span><span class="o">::</span><span class="n">mapped_file_source</span><span class="o">&gt;</span> <span class="n">raster_data_source_E</span><span class="p">;</span>     <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">converter</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">.</span><span class="n">mpi</span><span class="err">\</span><span class="n">_ranks</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">converter</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="n">converter</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="n">converter</span> <span class="o">&lt;&lt;</span> <span class="n">parameters</span><span class="p">.</span><span class="n">output</span><span class="err">\</span><span class="n">_file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;\_e.ras&quot;</span><span class="p">;</span>

<span class="n">raster</span><span class="err">\</span><span class="n">_data</span><span class="err">\</span><span class="n">_source</span><span class="err">\</span><span class="n">_E</span><span class="p">.</span><span class="n">emplace</span><span class="err">\</span><span class="n">_back</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">iostreams</span><span class="o">::</span><span class="n">mapped</span><span class="err">\</span><span class="n">_file</span><span class="err">\</span><span class="n">_source</span><span class="p">());</span>
<span class="n">raster</span><span class="err">\</span><span class="n">_data</span><span class="err">\</span><span class="n">_source</span><span class="err">\</span><span class="n">_E</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">open</span><span class="p">(</span><span class="n">converter</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
<p>Now, we have the files mapped. Let's say my files have data from 0 to
3600 seconds. I need to count the firing rate of my neurons at 2000
seconds. So, I need to get chunks from my 16 files that contain data
from 1999 to 2000 seconds. If you've studied computer science at all,
you should've had a &quot;<strong>BINARY SEARCH</strong>&quot; neon light light up in your
head at this point. I used something similar - <strong>upper and lower
bounds</strong>. Luckily, their algorithms, along with pseudo code are
documented
<a class="reference external" href="http://www.cplusplus.com/reference/algorithm/upper_bound/">here</a> and
<a class="reference external" href="http://www.cplusplus.com/reference/algorithm/lower_bound/">here</a>
respectively.</p>
<p>My implementations look like this:</p>
<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * ===  FUNCTION  ======================================================================</span>
<span class="cm"> *         Name:  binary_upper_bound</span>
<span class="cm"> *  Description:  Last occurence of a key using binary search</span>
<span class="cm"> * =====================================================================================</span>
<span class="cm"> */</span>
    <span class="kt">char</span> <span class="o">*</span>
<span class="nf">binary_upper_bound</span> <span class="p">(</span><span class="kt">double</span> <span class="n">timeToCompare</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">iostreams</span><span class="o">::</span><span class="n">mapped_file_source</span> <span class="o">&amp;</span><span class="n">openMapSource</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">spikesStart</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numEnd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">currentSpike</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numdiff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">sizeofstruct</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="o">*</span><span class="n">currentRecord</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/*  start of last record */</span>
    <span class="n">spikesStart</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">openMapSource</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
    <span class="n">numStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cm">/*  end of last record */</span>
    <span class="n">numEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">openMapSource</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="n">sizeofstruct</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="cm">/*  Number of structs */</span>

    <span class="n">numdiff</span> <span class="o">=</span> <span class="n">numEnd</span> <span class="o">-</span> <span class="n">numStart</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Finding last of &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">timeToCompare</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">sizediff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">spikesEnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">spikesEnd</span> <span class="o">=</span>  <span class="p">(</span><span class="n">spikesStart</span> <span class="o">+</span> <span class="n">openMapSource</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">sizeofstruct</span><span class="p">);</span>
    <span class="n">sizediff</span> <span class="o">=</span> <span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Struct size is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sizeofstruct</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Char size is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;size of int is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of records in this file: &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">openMapSource</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">sizeofstruct</span><span class="p">)</span><span class="o">/</span><span class="n">sizeofstruct</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of records in this file: &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">)</span><span class="o">/</span><span class="n">sizeofstruct</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;With printf subtraction %zun&quot;</span><span class="p">,(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Proper subtraction : &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sizediff : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sizediff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;With printf sizediff %zun&quot;</span><span class="p">,</span><span class="n">sizediff</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;multiplier &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">)</span><span class="o">/</span><span class="n">sizediff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of struct records in this file: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numdiff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">numCurrent</span> <span class="o">=</span> <span class="n">numStart</span><span class="p">;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">numdiff</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

        <span class="n">numCurrent</span> <span class="o">+=</span> <span class="n">step</span><span class="p">;</span>
        <span class="n">currentSpike</span> <span class="o">=</span> <span class="n">spikesStart</span> <span class="o">+</span> <span class="n">numCurrent</span> <span class="o">*</span> <span class="n">sizeofstruct</span><span class="p">;</span>
        <span class="n">currentRecord</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="o">*</span><span class="p">)</span><span class="n">currentSpike</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Current record is: &quot;</span> <span class="o">&lt;</span><span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t&quot;</span> <span class="o">&lt;</span><span class="n">neuronID</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; at line&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numCurrent</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timeToCompare</span> <span class="n">time</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">numStart</span> <span class="o">=</span> <span class="o">++</span><span class="n">numCurrent</span><span class="p">;</span>
            <span class="n">numdiff</span> <span class="o">-=</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
            <span class="n">numdiff</span> <span class="o">=</span> <span class="n">step</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">currentSpike</span> <span class="o">=</span> <span class="n">spikesStart</span> <span class="o">+</span> <span class="p">(</span><span class="n">numStart</span> <span class="o">*</span> <span class="n">sizeofstruct</span><span class="p">);</span>
    <span class="n">currentRecord</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="o">*</span><span class="p">)</span><span class="n">currentSpike</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning: &quot;</span> <span class="o">&lt;</span><span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t&quot;</span> <span class="o">&lt;</span><span class="n">neuronID</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">currentSpike</span><span class="p">;</span>
<span class="p">}</span>       <span class="cm">/* -----  end of function binary_upper_bound  ----- */</span>

<span class="cm">/*</span>
<span class="cm"> * ===  FUNCTION  ======================================================================</span>
<span class="cm"> *         Name:  binary_lower_bound</span>
<span class="cm"> *  Description:  First occurence of a key using binary search</span>
<span class="cm"> * =====================================================================================</span>
<span class="cm"> */</span>
    <span class="kt">char</span> <span class="o">*</span>
<span class="nf">binary_lower_bound</span> <span class="p">(</span><span class="kt">double</span> <span class="n">timeToCompare</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">iostreams</span><span class="o">::</span><span class="n">mapped_file_source</span> <span class="o">&amp;</span><span class="n">openMapSource</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">spikesStart</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numEnd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">currentSpike</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numdiff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">sizeofstruct</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="o">*</span><span class="n">currentRecord</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/*  start of last record */</span>
    <span class="n">spikesStart</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">openMapSource</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
    <span class="n">numStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cm">/*  end of last record */</span>
    <span class="n">numEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">openMapSource</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="n">sizeofstruct</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="cm">/*  Number of structs */</span>
    <span class="n">numdiff</span> <span class="o">=</span> <span class="n">numEnd</span> <span class="o">-</span> <span class="n">numStart</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Finding first of &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">timeToCompare</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">sizediff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">spikesEnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">spikesEnd</span> <span class="o">=</span>  <span class="p">(</span><span class="n">spikesStart</span> <span class="o">+</span> <span class="n">openMapSource</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">sizeofstruct</span><span class="p">);</span>
    <span class="n">sizediff</span> <span class="o">=</span> <span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Struct size is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sizeofstruct</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Char size is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;size of int is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of records in this file: &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">openMapSource</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">sizeofstruct</span><span class="p">)</span><span class="o">/</span><span class="n">sizeofstruct</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of records in this file: &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">)</span><span class="o">/</span><span class="n">sizeofstruct</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;With printf subtraction %zun&quot;</span><span class="p">,(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Proper subtraction : &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sizediff : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sizediff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;With printf sizediff %zun&quot;</span><span class="p">,</span><span class="n">sizediff</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;multiplier &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">spikesEnd</span> <span class="o">-</span> <span class="n">spikesStart</span><span class="p">)</span><span class="o">/</span><span class="n">sizediff</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of struct records in this file: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numdiff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">numCurrent</span> <span class="o">=</span> <span class="n">numStart</span><span class="p">;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">numdiff</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

        <span class="n">numCurrent</span> <span class="o">+=</span> <span class="n">step</span><span class="p">;</span>
        <span class="n">currentSpike</span> <span class="o">=</span> <span class="n">spikesStart</span> <span class="o">+</span> <span class="n">numCurrent</span> <span class="o">*</span> <span class="n">sizeofstruct</span><span class="p">;</span>
        <span class="n">currentRecord</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="o">*</span><span class="p">)</span><span class="n">currentSpike</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Current record is: &quot;</span> <span class="o">&lt;</span><span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t&quot;</span> <span class="o">&lt;</span><span class="n">neuronID</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; at line&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numCurrent</span> <span class="o">&lt;</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">timeToCompare</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">numStart</span> <span class="o">=</span> <span class="o">++</span><span class="n">numCurrent</span><span class="p">;</span>
            <span class="n">numdiff</span> <span class="o">-=</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
            <span class="n">numdiff</span> <span class="o">=</span> <span class="n">step</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">currentSpike</span> <span class="o">=</span> <span class="n">spikesStart</span> <span class="o">+</span> <span class="p">(</span><span class="n">numStart</span> <span class="o">*</span> <span class="n">sizeofstruct</span><span class="p">);</span>
    <span class="n">currentRecord</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span> <span class="o">*</span><span class="p">)</span><span class="n">currentSpike</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning: &quot;</span> <span class="o">&lt;</span><span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;t&quot;</span> <span class="o">&lt;</span><span class="n">neuronID</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">currentSpike</span><span class="p">;</span>
<span class="p">}</span>       <span class="cm">/* -----  end of function binary_lower_bound  ----- */</span>
</pre></div>
<p>The rest is quite simple, really. I ask a thread to go over all my 16
memory mapped files, find the chunks and store it in a vector. This is
then sorted and the frequency of occurrence of each neuron counted -
which is the firing rate. It looks like this:</p>
<div class="highlight"><pre><span></span><span class="cm">/*  Fill up my vectors with neurons that fired in this period */</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span>  <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">chunkit</span> <span class="o">=</span> <span class="n">chunk_start</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">chunkit</span> <span class="n">neuronID</span><span class="p">);</span>
            <span class="n">chunkit</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span><span class="p">);</span>

        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">timeToFly</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; not found in E file &quot;</span>  <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">chunkit</span> <span class="o">=</span> <span class="n">chunk_start</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">chunkit</span> <span class="n">neuronID</span><span class="p">);</span>
            <span class="n">chunkit</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spikeEvent_type</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">timeToFly</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; not found in I file &quot;</span>  <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;!n&quot;</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
<span class="cm">/*  Sort - makes next operations more efficient, or I think it does */</span>
<span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">neuronsE</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">neuronsE</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">neuronsI</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">neuronsI</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

<span class="cm">/*  Get frequencies of inhibitory neurons */</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">::</span><span class="n">iterator</span> <span class="n">search_begin</span> <span class="o">=</span> <span class="n">neuronsI</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">NI</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">search_begin</span><span class="p">,</span> <span class="n">neuronsI</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">neuronsI</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="o">?</span>  <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">search_begin</span><span class="p">,</span> <span class="n">neuronsI</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">search_begin</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">search_begin</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">search_begin</span><span class="p">,</span> <span class="n">neuronsI</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">neuronsI_rate</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*  We have the inhibitory firing rate! */</span>

<span class="cm">/* Get frequencies of excitatory neurons */</span>
<span class="n">search_begin</span> <span class="o">=</span> <span class="n">neuronsE</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">NE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">search_begin</span><span class="p">,</span> <span class="n">neuronsE</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">neuronsE</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="o">?</span>  <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">search_begin</span><span class="p">,</span> <span class="n">neuronsE</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">search_begin</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">search_begin</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">search_begin</span><span class="p">,</span> <span class="n">neuronsE</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">neuronsE_rate</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>The main method where I call my many threads would look something like
this:</p>
<div class="highlight"><pre><span></span><span class="cm">/* To see how long it takes, which I forgot to save to add to the post */</span>
<span class="n">clock_start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">task_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* graphing_times holds the times at which I need to extract chunks */</span>
<span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">graphing_times</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">graphing_times</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span> <span class="o">&gt;</span> <span class="n">extracted_data_temp</span><span class="p">;</span>
    <span class="cm">/*  Only start a new thread if less than thread_max threads are running */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">task_counter</span> <span class="o">&lt;</span> <span class="n">doctors_max</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Just a vector that keeps the currently running threads */</span>
        <span class="n">timeLords</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="p">(</span><span class="n">tardis</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">raster_data_source_E</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">raster_data_source_I</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">patterns</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">recalls</span><span class="p">),</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">parameters</span><span class="p">));</span>
        <span class="cm">/* I called my main worker method tardis - always good to make your code fun - there may be a dalek somewhere in my file too ;) */</span>
        <span class="n">task_counter</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* Original comment from the source file below */</span>
    <span class="cm">/*  If thread_max threads are running, wait for them to finish before</span>
<span class="cm">     *  starting a second round.</span>
<span class="cm">     *</span>
<span class="cm">     *  Yes, this can be optimised by using a thread pool but I really</span>
<span class="cm">     *  don&#39;t have the patience to look into ThreadPool or a</span>
<span class="cm">     *  boost::thread_group today!</span>
<span class="cm">     */</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="o">&amp;</span><span class="nl">t</span><span class="p">:</span> <span class="n">timeLords</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
                <span class="n">task_counter</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">timeLords</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*  Wait for remaining threads to finish */</span>
<span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="o">&amp;</span><span class="nl">t</span><span class="p">:</span> <span class="n">timeLords</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">timeLords</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="n">clock_end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
</pre></div>
<p>I'm not using a threadpool since the C++ standard doesn't provide one,
and quite frankly, since I'm only making my threads read, I didn't need
an implementation with mutexes and locks. I just use a certain number of
threads at a time and wait for them to finish before starting the next
batch.</p>
<p>The last time I ran my post processing script without memory mapped
files, it took my system quite a while just to load the files. Once the
files were loaded into memory, the processing bit was quite quick,
obviously. However, with memory mapped files, I recently pulled out
4000+ chunks (I had a total of 11000+ graphs generated, so yeah, 4000+
chunks) in a tiny 230seconds. I'll try and benchmark it again when I run
it next and provide &quot;official&quot; figures.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Well, in conclusion, memory mapped files are awesome - spend some time
on them if you're processing large amounts of structured information -
you'll take some time to learn how to use them, but your code will scale
as your data gets larger and larger.</p>
</div>

  </div>
  
  <hr />
  <div class="well well-sm">  <!-- Social media sharing buttons -->
    <!-- Twitter -->
    <a href="https://twitter.com/share" class="twitter-share-button" 
       data-via="sanjay_ankur" >Tweet</a>&nbsp;

    <!-- Google+ -->
    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <div class="g-plusone" data-size="medium"></div>&nbsp;

    <!-- Facebook -->
    <div class="fb-like" 
        data-href="http://ankursinha.in/2015/02/20/extracting-small-chunks-of-data-from-extremely-large-files-say-hello-to-memory-mapped-files.html" 
        data-layout="button_count" 
        data-action="like" data-show-faces="true" 
        data-share="true">
    </div>
    &nbsp;
  </div> <!-- /Social media sharing buttons -->
  <div class="comments">
	<h2>Comments</h2>
	<div id="disqus_thread"></div>
	<script type="text/javascript">
				   (function() {
						var dsq = document.createElement('script');
						dsq.type = 'text/javascript'; dsq.async = true;
						dsq.src = '//ankursinha.disqus.com/embed.js';
						(document.getElementsByTagName('head')[0] ||
						 document.getElementsByTagName('body')[0]).appendChild(dsq);
				  })();
	</script>
  </div>
</article>
        </div><!-- /content -->

        <div class="col-md-3 sidebar-nav" id="sidebar">

<div class="row">

<div class="col-xs-6 col-md-12">
<h4><i class="fas fa-comment fa-fw fa-lg"></i> Social</h4>
<ul class="list-unstyled social-links">
    <li><a href="http://scholar.google.co.in/citations?user=919ScZEAAAAJ&hl=en" target="_blank">
	  <i class="fas fa-graduation-cap fa-fw fa-lg" title="Scholar"></i>
		Scholar
	</a></li>
    <li><a href="http://github.com/sanjayankur31" target="_blank">
	  <i class="fab fa-github fa-fw fa-lg" title="GitHub"></i>
		GitHub
	</a></li>
    <li><a href=" https://orcid.org/0000-0001-7568-7167" target="_blank">
	  <i class="fas fa-flask fa-fw fa-lg" title="Orcid"></i>
		Orcid
	</a></li>
    <li><a href="https://neurotree.org/neurotree/tree.php?pid=96687" target="_blank">
	  <i class="fas fa-tree fa-fw fa-lg" title="NeuroTree"></i>
		NeuroTree
	</a></li>
    <li><a href="https://fedoraproject.org/wiki/User:Ankursinha" target="_blank">
	  <i class="fab fa-linux fa-fw fa-lg" title="Fedora"></i>
		Fedora
	</a></li>
    <li><a href="https://www.goodreads.com/user/show/32360473-ankur" target="_blank">
	  <i class="fab fa-goodreads-g fa-fw fa-lg" title="Goodreads"></i>
		Goodreads
	</a></li>
    <li><a href="https://twitter.com/sanjay_ankur" target="_blank">
	  <i class="fab fa-twitter fa-fw fa-lg" title="Twitter"></i>
		Twitter
	</a></li>
    <li><a href="http://www.last.fm/user/sanjay_ankur" target="_blank">
	  <i class="fab fa-lastfm fa-fw fa-lg" title="Last.fm"></i>
		Last.fm
	</a></li>
</ul>
</div>

<div class="col-xs-6 col-md-12">
<h4><i class="fas fa-folder fa-fw fa-lg"></i> Categories</h4>
<ul class="list-unstyled category-links">
  <li><a href="http://ankursinha.in/category/life/" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Life</a></li>
  <li><a href="http://ankursinha.in/category/other/" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Other</a></li>
  <li><a href="http://ankursinha.in/category/research/" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Research</a></li>
  <li><a href="http://ankursinha.in/category/tech/" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Tech</a></li>
</ul>
</div>

</div> <!-- /row -->

  <h4><i class="fas fa-link fa-fw fa-lg"></i> Links</h4>
  <ul class="list-unstyled category-links">
    <li><a href="https://u.fsf.org/user-liberation" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Free Software Foundation</a></li>
    <li><a href="http://fedoraproject.org" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Fedora Project</a></li>
    <li><a href="http://tug.org/" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> TeX Users Group</a></li>
    <li><a href="https://ocns.memberclicks.net/" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> OCNS</a></li>
    <li><a href="http://home.earthlink.net/~perlewitz/index.html" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Comp Neuro on the Web</a></li>
    <li><a href="http://fedoraproject.org" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Fedora Project</a></li>
    <li><a href="https://fedoraproject.org/wiki/SIGs/NeuroFedora" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> NeuroFedora</a></li>
    <li><a href="https://sanjayankur31.github.io/planet-neuroscience/" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Neuroscience feeds</a></li>
    <li><a href="https://sanjayankur31.github.io/planet-neuroscientists/" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Neuroscientists feeds</a></li>
    <li><a href="https://twitter.com/sanjay_ankur/lists/neuroscience" >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> My neuroscience list on Twitter</a></li>
    <li><a href="https://gitter.im/neuroscience-central/Lobby " >
      <i class="fas fa-external-link-square-alt fa-fw fa-lg"></i> Neuroscience central (chat)</a></li>
  </ul>
<h4><i class="fas fa-tags fa-fw fa-lg"></i> Tags</h4>
<p class="tag-cloud">
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/android/">
          <i class="fas fa-tag"></i>
        Android
      </a>
    </span>
    <span class="tag-1">
      <a href="http://ankursinha.in/tag/fedora/">
          <i class="fas fa-tag"></i>
        Fedora
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/flatpak/">
          <i class="fas fa-tag"></i>
        FlatPak
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/free-software/">
          <i class="fas fa-tag"></i>
        Free software
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/community/">
          <i class="fas fa-tag"></i>
        Community
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/numpy/">
          <i class="fas fa-tag"></i>
        Numpy
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/python/">
          <i class="fas fa-tag"></i>
        Python
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/robotics/">
          <i class="fas fa-tag"></i>
        Robotics
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/vim/">
          <i class="fas fa-tag"></i>
        Vim
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/pelican/">
          <i class="fas fa-tag"></i>
        Pelican
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/calliope/">
          <i class="fas fa-tag"></i>
        Calliope
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/nest/">
          <i class="fas fa-tag"></i>
        NEST
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/taskwarrior/">
          <i class="fas fa-tag"></i>
        Taskwarrior
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/tex/">
          <i class="fas fa-tag"></i>
        TeX
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/planet/">
          <i class="fas fa-tag"></i>
        Planet
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/events/">
          <i class="fas fa-tag"></i>
        Events
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/pandas/">
          <i class="fas fa-tag"></i>
        Pandas
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/git/">
          <i class="fas fa-tag"></i>
        Git
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/social/">
          <i class="fas fa-tag"></i>
        Social
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/programming/">
          <i class="fas fa-tag"></i>
        Programming
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/bash/">
          <i class="fas fa-tag"></i>
        Bash
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/reproducible-research/">
          <i class="fas fa-tag"></i>
        Reproducible research
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/computational-neuroscience/">
          <i class="fas fa-tag"></i>
        Computational neuroscience
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/irc/">
          <i class="fas fa-tag"></i>
        IRC
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/gnome/">
          <i class="fas fa-tag"></i>
        GNOME
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/neurofedora/">
          <i class="fas fa-tag"></i>
        NeuroFedora
      </a>
    </span>
    <span class="tag-3">
      <a href="http://ankursinha.in/tag/neuron/">
          <i class="fas fa-tag"></i>
        Neuron
      </a>
    </span>
    <span class="tag-4">
      <a href="http://ankursinha.in/tag/sumatra/">
          <i class="fas fa-tag"></i>
        Sumatra
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/linux/">
          <i class="fas fa-tag"></i>
        Linux
      </a>
    </span>
    <span class="tag-2">
      <a href="http://ankursinha.in/tag/latex/">
          <i class="fas fa-tag"></i>
        LaTeX
      </a>
    </span>
</p>
<h4><i class="fas fa-rss fa-fw fa-lg"></i> Feeds</h4>
<ul class="list-unstyled">
    <li><a href="http://ankursinha.in/feeds/all.atom.xml" 
		   type="application/atom+xml" rel="alternate">
		<i class="fas fa-rss-square fa-fw fa-lg"></i> Atom Feed</a></li>
    <li><a href="http://ankursinha.in/feeds/all.rss.xml" 
		   type="application/rss+xml" rel="alternate">
		<i class="fas fa-rss-square fa-fw fa-lg"></i> RSS feed</a></li>
</ul>

<hr />

        </div><!--/sidebar -->
      </div><!--/row-->
    </div><!--/.container /#main-container -->

    <footer id="site-footer">
 
      <address id="site-colophon">
        <p class="text-center text-muted">
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/" target="_blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /><a href="http://ankursinha.in/" target="_blank" xmlns:dct="http://purl.org/dc/terms/" property="dct:title">ankursinha.in</a> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://ankursinha.in/pages/01-about.html" property="cc:attributionName" rel="cc:attributionURL" target="_blank">Ankur Sinha</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/" target="_blank">Creative Commons Attribution 4.0 International License</a>.<br />
        Site built using <a href="http://getpelican.com/" target="_blank">Pelican</a>
        &nbsp;&bull;&nbsp; Theme based on
        <a href="http://www.voidynullness.net/page/voidy-bootstrap-pelican-theme/"
           target="_blank">VoidyBootstrap</a> by 
        <a href="http://www.robertiwancz.com/"
           target="_blank">RKI</a>  
        </p>
      </address><!-- /colophon  -->
    </footer>

<!-- DISQUS script for displaying comment count -->
<script type="text/javascript">
    var disqus_shortname = 'ankursinha';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- javascript -->
   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>


<!-- Facebook -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>

<!-- Twitter -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<!-- Google+ -->
<!-- Synchronous 
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
-->
<!-- Asynchronous -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>  </body>
</html>